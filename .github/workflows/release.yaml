---
name: Build and Release Clu

on:
  push:
    tags:
      - "v[0-9]*"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        # If using git commands later, you might need fetch-depth: 0
        # with:
        #   fetch-depth: 0

      - name: Setup Go (stable)
        uses: actions/setup-go@v6
        with:
          go-version: "stable"
          check-latest: true
          cache: true

      - name: Build binaries
        run: |
          # Define output names
          ARTIFACT_NAME="clu-${{ matrix.goos }}-${{ matrix.goarch }}"
          ARTIFACT_DIR="dist/${ARTIFACT_NAME}"
          mkdir -p "${ARTIFACT_DIR}"

          # Build binary with debug symbols and platform-specific name
          CGO_ENABLED=0 GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} go build -ldflags "-X github.com/huntermatthews/clu/pkg.Version=${{ github.ref_name }}" -o "${ARTIFACT_DIR}/clu-${{ matrix.goos }}-${{ matrix.goarch }}" ./cmd/main.go

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-${{ matrix.goos }}-${{ matrix.goarch }}
          path: dist/clu-${{ matrix.goos }}-${{ matrix.goarch }}/*

  create-release:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download all release assets
        uses: actions/download-artifact@v4
        with:
          path: dist/
          pattern: release-assets-*
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          body: |
            Release ${{ github.ref_name }}.
            Download / deploy with
            `curl -fsSL -o clu https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/clu-linux-amd64 && chmod +x clu`
          files: |
            dist/*
          fail_on_unmatched_files: true

  build-rpm:
    runs-on: ubuntu-latest
    needs: create-release
    steps:
      - name: Download source tarball
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          # Note: Cannot use download-artifact here - GitHub archives are external to workflow artifacts
          curl -fsSL -o clu-$VERSION.tar.gz \
            https://github.com/${{ github.repository }}/archive/refs/tags/${{ github.ref_name }}.tar.gz

      - name: Extract and prepare source
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          tar -xzf clu-$VERSION.tar.gz
          # GitHub archives create clu-{tag} directory, rename to clu-{version}
          if [ -d "clu-${{ github.ref_name }}" ] && [ ! -d "clu-$VERSION" ]; then
            mv "clu-${{ github.ref_name }}" "clu-$VERSION"
          fi

      - name: Install RPM build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm

      - name: Setup Go (stable)
        uses: actions/setup-go@v6
        with:
          go-version: "stable"
          check-latest: true
          cache: false # Disable cache - no go.sum available in tarball-based build

      - name: Setup RPM build directory
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          # Create RPM build directory manually - rpmdevtools not available in Ubuntu repositories
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          cp clu-$VERSION.tar.gz ~/rpmbuild/SOURCES/
          cp clu-$VERSION/redhat/clu.spec ~/rpmbuild/SPECS/

      - name: Build RPM
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          rpmbuild --define "_version $VERSION" \
                   -bb ~/rpmbuild/SPECS/clu.spec

      - name: Upload RPM artifact
        uses: actions/upload-artifact@v4
        with:
          name: rpm-package
          path: ~/rpmbuild/RPMS/x86_64/*.rpm

  build-rpm-el7:
    runs-on: ubuntu-latest
    container: centos:7
    needs: create-release
    steps:
      - name: Configure EPEL repository
        run: |
          # Install EPEL for CentOS 7 using archived repository
          yum install -y https://archives.fedoraproject.org/pub/archive/epel/7/x86_64/Packages/e/epel-release-7-14.noarch.rpm
          # Update EPEL repo to use archived URLs
          sed -i 's|^#baseurl=https://download.fedoraproject.org/pub/epel|baseurl=https://archives.fedoraproject.org/pub/archive/epel|g' /etc/yum.repos.d/epel.repo
          sed -i 's|^mirrorlist|#mirrorlist|g' /etc/yum.repos.d/epel.repo

      - name: Install dependencies
        run: |
          # Fix CentOS 7 EOL mirror issues by using vault archives
          sed -i 's/mirrorlist/#mirrorlist/g' /etc/yum.repos.d/CentOS-*.repo
          sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-*.repo
          yum update -y
          yum install -y rpm-build rpmdevtools git curl golang

      - name: Download source tarball
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          curl -fsSL -o clu-$VERSION.tar.gz \
            https://github.com/${{ github.repository }}/archive/refs/tags/${{ github.ref_name }}.tar.gz

      - name: Extract and prepare source
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          tar -xzf clu-$VERSION.tar.gz

      - name: Setup RPM build directory
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          rpmdev-setuptree
          cp clu-$VERSION.tar.gz ~/rpmbuild/SOURCES/
          cp clu-$VERSION/redhat/clu.spec ~/rpmbuild/SPECS/

      - name: Build RHEL7 RPM
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          rpmbuild --define "_version $VERSION" \
                   -bb ~/rpmbuild/SPECS/clu.spec

      - name: Rename RPM for EL7
        run: |
          cd ~/rpmbuild/RPMS/x86_64/
          for rpm in clu-*.rpm; do
            mv "$rpm" "${rpm%.rpm}.el7.rpm"
          done

      - name: Install GitHub CLI and upload RPM
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          # Install GitHub CLI in CentOS 7
          yum install -y https://github.com/cli/cli/releases/download/v2.40.1/gh_2.40.1_linux_amd64.rpm

          # Upload RPM directly to the existing release
          cd ~/rpmbuild/RPMS/x86_64/
          for rpm in *.rpm; do
            gh release upload $GITHUB_REF_NAME "$rpm" --repo ${{ github.repository }}
          done

  build-deb:
    runs-on: ubuntu-latest
    container: ubuntu:20.04
    needs: create-release
    steps:
      - name: Install dependencies and DEB build tools
        env:
          DEBIAN_FRONTEND: noninteractive
          TZ: UTC
          APT_KEY_DONT_WARN_ON_DANGEROUS_USAGE: "1"
        run: |
          apt-get update -qq
          apt-get install -y -qq --no-install-recommends ca-certificates curl git dpkg-dev build-essential debhelper

      - name: Download source tarball
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          curl -fsSL -o clu-$VERSION.tar.gz \
            https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/clu-$VERSION.tar.gz

      - name: Extract and prepare source
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          tar -xzf clu-$VERSION.tar.gz

          # Create Debian orig tarball (required naming convention)
          cp clu-$VERSION.tar.gz clu_$VERSION.orig.tar.gz

      - name: Setup Go (stable)
        uses: actions/setup-go@v6
        with:
          go-version: "stable"
          check-latest: true
          cache: true

      - name: Verify build dependencies
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          cd clu-$VERSION

          # Verify we can satisfy build dependencies
          dpkg-checkbuilddeps || echo "Warning: Some build deps may not be satisfied by apt packages, but Go is available via actions/setup-go"

      - name: Build DEB package
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          cd clu-$VERSION

          # Update debian/changelog with current version
          sed -i "1s/([^)]*)/($VERSION-1)/" debian/changelog

          # Build the DEB package
          dpkg-buildpackage -us -uc -b

          # Move the .deb file to a predictable location
          mv ../clu_${VERSION}-1_amd64.deb ./clu_${VERSION}-1_amd64.deb

      - name: Upload DEB artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-package
          path: clu-*/clu_*_amd64.deb

  update-release:
    runs-on: ubuntu-latest
    needs: [build-rpm, build-rpm-el7, build-deb]
    steps:
      - name: Download RPM packages
        uses: actions/download-artifact@v4
        with:
          path: rpms/
          pattern: rpm-package*
          merge-multiple: true

      - name: Download DEB package
        uses: actions/download-artifact@v4
        with:
          path: debs/
          pattern: deb-package*
          merge-multiple: true

      - name: Upload packages to existing release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            rpms/*
            debs/*
          fail_on_unmatched_files: true
# TODO: Future workflow improvements to consider:
# @AI-ASSISTANTS @CLAUDE @GPT: DO NOT RENUMBER - ONLY APPEND
#
# 1. Add a 'test' job:
#    - Should run before the 'build' job.
#    - Use 'go test -v ./...' to run unit tests.
#    - Make the 'build' job dependent on the 'test' job passing (needs: test).
#
# 2. Generate checksums:
#    - Add a step in the 'build' job after compression.
#    - Use 'sha256sum' to create a checksum file (e.g., SHA256SUMS).
#    - Upload the checksum file as part of the release assets.
#    - This requires renaming artifacts to be platform-specific to avoid collisions.
#
# 3. Automate release notes:
#    - In the 'release' job, add 'generate_release_notes: true' to the
#      'softprops/action-gh-release' step.
#
# 4. Implement SLSA Level 3 attestations:
#    - Remove the top-level 'permissions' block.
#    - Add job-level permissions to the 'build' job:
#      permissions:
#        attestations: write
#        id-token: write
#    - Add job-level permissions to the 'release' job:
#      permissions:
#        contents: write
#
# 5. Replace softprops/action-gh-release with the official 'gh' CLI:
#    - Replace the 'Create GitHub Release' step with a 'run' step using 'gh'.
#    - Use 'gh release create <tag> dist/* --notes-file notes.md' to upload assets.
#    - The release body would be written to 'notes.md' first.
#    - Requires 'contents: write' permission and GITHUB_TOKEN in the env.
#
# 8. Add Homebrew formula support:
#    - This is typically handled differently. Instead of a binary, you would update a
#      formula file in a separate repository (a "tap").
#    - A new job could be added to automatically update the formula (URL, sha256)
#      and push it to the Homebrew tap repository upon a new release.
#
# 9. Add email notification for manual signing:
#     - Add a final 'notify' job that 'needs: release'.
#     - Use a marketplace action like 'dawidd6/action-send-mail'.
#     - Configure it with SMTP server details stored in repository secrets.
#     - The email body should contain the release URL and a reminder to sign artifacts.
#
# 10. Add container verification:
#     - Pin container images using SHA256 digests for immutable references.
#     - Change 'container: centos:7' to 'container: centos:7@sha256:...' format.
#     - Alternatively, verify using official registry sources only.
#     - This ensures build reproducibility and prevents supply chain attacks.
#
# 11. Add manual trigger for debugging:
#    - Add 'workflow_dispatch' to the 'on' section to enable manual triggering.
#    - Include input parameter for tag simulation (e.g., 'v0.8.4').
#    - This allows testing workflow without creating actual tags.
