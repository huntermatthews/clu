---
name: Build RPM Package (EL7)

on:
  workflow_call:

env:
  BUILD_HOST: action-runner.github.com

jobs:
  build-rpm-el7:
    name: "Package RPM (CentOS 7)"
    runs-on: ubuntu-latest
    container: centos:7
    permissions:
      attestations: write
      id-token: write
    env:
      GITHUB_REF_NAME: ${{ github.ref_name }}
    steps:
      - name: Set VERSION variable
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Configure EPEL repository
        run: |
          # Install EPEL for CentOS 7 using archived repository
          yum install -y https://archives.fedoraproject.org/pub/archive/epel/7/x86_64/Packages/e/epel-release-7-14.noarch.rpm
          # Update EPEL repo to use archived URLs
          sed -i 's|^#baseurl=https://download.fedoraproject.org/pub/epel|baseurl=https://archives.fedoraproject.org/pub/archive/epel|g' /etc/yum.repos.d/epel.repo
          sed -i 's|^mirrorlist|#mirrorlist|g' /etc/yum.repos.d/epel.repo

      - name: Install dependencies
        run: |
          # Fix CentOS 7 EOL mirror issues by using vault archives
          sed -i 's/mirrorlist/#mirrorlist/g' /etc/yum.repos.d/CentOS-*.repo
          sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-*.repo
          yum update -y
          yum install -y rpm-build rpmdevtools git curl golang

      - name: Download source tarball
        run: |
          curl -fsSL -o clu-$VERSION.tar.gz \
            https://github.com/${{ github.repository }}/archive/refs/tags/${{ github.ref_name }}.tar.gz

      - name: Extract and prepare source
        run: |
          tar -xzf clu-$VERSION.tar.gz

      - name: Setup RPM build directory
        run: |
          rpmdev-setuptree
          cp clu-$VERSION.tar.gz ~/rpmbuild/SOURCES/
          cp clu-$VERSION/redhat/clu.spec ~/rpmbuild/SPECS/

      - name: Build RHEL7 RPM
        run: |
          rpmbuild --define "_version $VERSION" --define "_buildhost $BUILD_HOST" --target x86_64 \
                   -bb ~/rpmbuild/SPECS/clu.spec

      - name: Rename RPM for EL7
        run: |
          cd ~/rpmbuild/RPMS/x86_64/
          mv clu-*.rpm clu-$VERSION-1.x86_64.el7.rpm

      - name: Install GitHub CLI
        run: |
          # Install GitHub CLI in CentOS 7
          yum install -y https://github.com/cli/cli/releases/download/v2.40.1/gh_2.40.1_linux_amd64.rpm

      - name: Generate SLSA attestation and upload RPM
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd ~/rpmbuild/RPMS/x86_64/
          RPM_FILE="clu-$VERSION-1.x86_64.el7.rpm"

          # Generate SLSA attestation for the RPM
          gh attestation create --type "build-provenance" --subject "$RPM_FILE" --repo ${{ github.repository }}

          # Upload RPM to the existing release
          gh release upload $GITHUB_REF_NAME "$RPM_FILE" --repo ${{ github.repository }}
