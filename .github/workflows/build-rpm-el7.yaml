---
name: Build RPM Package (EL7)

on:
  workflow_call:

env:
  BUILD_HOST: action-runner.github.com

jobs:
  build-rpm-el7:
    name: "Package RPM (CentOS 7)"
    runs-on: ubuntu-latest
    container: centos:7
    # Note: Permissions are set in the calling workflow (release.yaml)
    env:
      GITHUB_REF_NAME: ${{ github.ref_name }}
    steps:
      - name: Set VERSION variable
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Configure EPEL repository
        run: |
          # Install EPEL for CentOS 7 using archived repository
          yum install -y https://archives.fedoraproject.org/pub/archive/epel/7/x86_64/Packages/e/epel-release-7-14.noarch.rpm
          # Update EPEL repo to use archived URLs
          sed -i 's|^#baseurl=https://download.fedoraproject.org/pub/epel|baseurl=https://archives.fedoraproject.org/pub/archive/epel|g' /etc/yum.repos.d/epel.repo
          sed -i 's|^mirrorlist|#mirrorlist|g' /etc/yum.repos.d/epel.repo

      - name: Install dependencies
        run: |
          # Disable fastestmirror plugin to avoid hanging
          echo "enabled=0" >> /etc/yum/pluginconf.d/fastestmirror.conf

          # Fix CentOS 7 EOL mirror issues by using vault archives
          sed -i 's/mirrorlist/#mirrorlist/g' /etc/yum.repos.d/CentOS-*.repo
          sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-*.repo

          # Clear yum cache and force rebuild
          yum clean all
          yum makecache --disableplugin=fastestmirror

          # Install packages without fastestmirror plugin
          yum install -y --disableplugin=fastestmirror rpm-build rpmdevtools git curl golang

      - name: Download source tarball
        run: |
          # Use GitHub API for private repo tarballs
          curl -fsSL -o clu-$VERSION.tar.gz \
            --header 'authorization: Bearer ${{ secrets.GITHUB_TOKEN }}' \
            --header 'Accept: application/vnd.github+json' \
            --header 'X-GitHub-Api-Version: 2022-11-28' \
            "https://api.github.com/repos/${{ github.repository }}/tarball/${{ github.ref_name }}"

      - name: Inspect tarball contents (debug)
        run: |
          echo "Top-level entries in tarball:"
          tar -tzf "clu-$VERSION.tar.gz" | cut -d/ -f1 | sort -u
          echo "Sample of tar listing (first 20):"
          tar -tzf "clu-$VERSION.tar.gz" | head -n 20

      - name: Extract and prepare source
        run: |
          echo "Before extract, working directory contents:" && ls -la
          tar -xzf clu-$VERSION.tar.gz
          echo "After extract, working directory contents:" && ls -la

      - name: Setup RPM build directory
        run: |
          rpmdev-setuptree
          cp clu-$VERSION.tar.gz ~/rpmbuild/SOURCES/
          cp clu-$VERSION/redhat/clu.spec ~/rpmbuild/SPECS/

      - name: Build RHEL7 RPM
        run: |
          rpmbuild --define "_version $VERSION" --define "_buildhost $BUILD_HOST" --target x86_64 \
                   -bb ~/rpmbuild/SPECS/clu.spec

      - name: Rename RPM for EL7
        run: |
          cd ~/rpmbuild/RPMS/x86_64/
          mv clu-*.rpm clu-$VERSION-1.x86_64.el7.rpm

      - name: Install GitHub CLI
        run: |
          # Install current GitHub CLI version that supports attestation
          yum install -y https://github.com/cli/cli/releases/download/v2.83.0/gh_2.83.0_linux_amd64.rpm

      # Note: Skipping SLSA attestation - gh CLI in CentOS 7 doesn't support attestation creation
      # Other workflows provide attestations via GitHub Actions

      - name: Upload RPM to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd ~/rpmbuild/RPMS/x86_64/
          RPM_FILE="clu-$VERSION-1.x86_64.el7.rpm"

          # Upload RPM to the existing release
          gh release upload $GITHUB_REF_NAME "$RPM_FILE" --repo ${{ github.repository }}
