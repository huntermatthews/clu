---
name: Build and Release Clu

on:
  push:
    tags:
      - "v[0-9]*"

env:
  BUILD_HOST: action-runner.github.com

jobs:
  build:
    name: "Compile Go Binaries"
    runs-on: ubuntu-latest
    permissions:
      contents: read
      attestations: write
      id-token: write
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: arm64
          - goos: windows
            goarch: amd64

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        # If using git commands later, you might need fetch-depth: 0
        # with:
        #   fetch-depth: 0

      - name: Setup Go (stable)
        uses: actions/setup-go@v6
        with:
          go-version: "stable"
          check-latest: true
          cache: true

      - name: Build binaries
        run: |
          # Define output names
          ARTIFACT_NAME="clu-${{ matrix.goos }}-${{ matrix.goarch }}"
          ARTIFACT_DIR="dist/${ARTIFACT_NAME}"
          mkdir -p "${ARTIFACT_DIR}"

          # Build binary with debug symbols and platform-specific name
          CGO_ENABLED=0 GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} go build -ldflags "-X github.com/NHGRI/clu/pkg.Version=${{ github.ref_name }}" -o "${ARTIFACT_DIR}/clu-${{ matrix.goos }}-${{ matrix.goarch }}" ./cmd/main.go

      - name: Generate checksums
        run: |
          # Create a platform-specific checksum file for easier aggregation
          sha256sum dist/clu-${{ matrix.goos }}-${{ matrix.goarch }}/clu-${{ matrix.goos }}-${{ matrix.goarch }} > dist/SHA256SUMS-${{ matrix.goos }}-${{ matrix.goarch }}

      - name: Generate SLSA attestation
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: dist/clu-${{ matrix.goos }}-${{ matrix.goarch }}/clu-${{ matrix.goos }}-${{ matrix.goarch }}

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: release-assets-${{ matrix.goos }}-${{ matrix.goarch }}
          path: |
            dist/clu-${{ matrix.goos }}-${{ matrix.goarch }}/*
            dist/SHA256SUMS-${{ matrix.goos }}-${{ matrix.goarch }}

  create-release:
    name: "Create GitHub Release"
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
    steps:
      - name: Set VERSION variable
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          body: |
            Release ${{ github.ref_name }}.
            Download / deploy with
            `curl -fsSL -o clu https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/clu-linux-amd64 && chmod +x clu`

            ## SLSA Attestation Verification
            All artifacts except the EL7 RPM have SLSA build provenance attestations. Verify with:

            **Binaries:**
            ```bash
            # Linux AMD64
            gh attestation verify clu-linux-amd64 --owner ${{ github.repository_owner }}
            # Linux ARM64
            gh attestation verify clu-linux-arm64 --owner ${{ github.repository_owner }}
            # macOS ARM64
            gh attestation verify clu-darwin-arm64 --owner ${{ github.repository_owner }}
            # Windows AMD64
            gh attestation verify clu-windows-amd64 --owner ${{ github.repository_owner }}
            ```

            **RPM Packages:**
            ```bash
            # x86_64 RPM
            gh attestation verify clu-${{ env.VERSION }}-1.x86_64.rpm --owner ${{ github.repository_owner }}
            # Note: EL7 RPM does not have attestation due to toolchain limitations
            ```

            **DEB Packages:**
            ```bash
            # AMD64 DEB
            gh attestation verify clu_${{ env.VERSION }}-1_amd64.deb --owner ${{ github.repository_owner }}
            # ARM64 DEB
            gh attestation verify clu_${{ env.VERSION }}-1_arm64.deb --owner ${{ github.repository_owner }}
            ```

  build-rpm-packages:
    name: "Build RPM Packages (Ubuntu)"
    needs: create-release
    permissions:
      contents: read
      attestations: write
      id-token: write
    strategy:
      matrix:
        include:
          - architecture: x86_64
            runner: ubuntu-latest
          # Temporarily disabled - ARM runner availability issues
          # - architecture: aarch64
          #   runner: ubuntu-latest-arm
    uses: ./.github/workflows/build-rpm.yaml
    with:
      architecture: ${{ matrix.architecture }}
      runner: ${{ matrix.runner }}

  build-rpm-el7:
    name: "Build RPM Package (CentOS 7)"
    needs: create-release
    permissions:
      contents: write
    uses: ./.github/workflows/build-rpm-el7.yaml

  build-deb-packages:
    name: "Build DEB Packages"
    needs: create-release
    permissions:
      contents: read
      attestations: write
      id-token: write
    strategy:
      matrix:
        include:
          - architecture: amd64
            runner: ubuntu-latest
          # Temporarily disabled - ARM runner availability issues
          # - architecture: arm64
          #   runner: ubuntu-latest-arm
    uses: ./.github/workflows/build-deb.yaml
    with:
      architecture: ${{ matrix.architecture }}
      runner: ${{ matrix.runner }}

  upload-all-assets:
    name: "Upload All Assets to Release"
    runs-on: ubuntu-latest
    needs: [build, build-rpm-packages, build-rpm-el7, build-deb-packages]
    permissions:
      contents: write
    steps:
      - name: Download binary artifacts
        uses: actions/download-artifact@v7
        with:
          path: dist/
          pattern: release-assets-*
          merge-multiple: true

      - name: Create master checksum file
        run: |
          # Combine all platform-specific checksum files into one master file
          cat dist/SHA256SUMS-* > dist/SHA256SUMS

          # Add header to master checksum file
          sed -i '1i# SHA256 Checksums for clu ${{ github.ref_name }}' dist/SHA256SUMS

          # Clean up individual platform checksum files
          rm -f dist/SHA256SUMS-*

      - name: Download RPM packages
        uses: actions/download-artifact@v7
        with:
          path: rpms/
          pattern: rpm-package*
          merge-multiple: true

      - name: Download DEB package
        uses: actions/download-artifact@v7
        with:
          path: debs/
          pattern: deb-package*
          merge-multiple: true

      - name: Upload all assets to release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            dist/**/*
            rpms/*
            debs/*
          fail_on_unmatched_files: true
#
#
#
#
# TODO: Future workflow improvements to consider:
# @AI-ASSISTANTS @CLAUDE @GPT: DO NOT RENUMBER - ONLY APPEND
#
# 10. Add container verification:
#     - Pin container images using SHA256 digests for immutable references.
#     - Change 'container: centos:7' to 'container: centos:7@sha256:...' format.
#     - Alternatively, verify using official registry sources only.
#     - This ensures build reproducibility and prevents supply chain attacks.
#
# 15. Documentation updates:
#     - DEB packages work on Proxmox hosts
#     - no relationship between workflows and scripts/ - scripts just there for debugging/local builds.
#
